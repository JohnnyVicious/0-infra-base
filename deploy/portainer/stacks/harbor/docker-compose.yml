version: '3.8'

services:
  redis:
    image: bitnami/redis:7.2
    container_name: harbor-redis
    restart: unless-stopped
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_DISABLE_COMMANDS=FLUSHDB,FLUSHALL
    volumes:
      - redis_data:/bitnami/redis/data
    env_file:
      - stack.env
    networks:
      - harbor

  postgresql:
    image: bitnami/postgresql:15
    container_name: harbor-postgresql
    restart: unless-stopped
    environment:
      - POSTGRESQL_USERNAME=${POSTGRESQL_USERNAME}
      - POSTGRESQL_PASSWORD=${POSTGRESQL_PASSWORD}
      - POSTGRESQL_DATABASE=${POSTGRESQL_DATABASE}
    volumes:
      - postgresql_data:/bitnami/postgresql
    env_file:
      - stack.env
    networks:
      - harbor

  registry:
    image: bitnami/harbor-registry:${HARBOR_VERSION:-2.10.2}
    container_name: harbor-registry
    restart: unless-stopped
    environment:
      - REGISTRY_HTTP_SECRET=${REGISTRY_HTTP_SECRET}
      - REGISTRY_STORAGE_PROVIDER_NAME=filesystem
    volumes:
      - registry_data:/storage
      - registry_conf:/etc/registry
    env_file:
      - stack.env
    depends_on:
      - redis
    networks:
      - harbor

  registryctl:
    image: bitnami/harbor-registryctl:${HARBOR_VERSION:-2.10.2}
    container_name: harbor-registryctl
    restart: unless-stopped
    environment:
      - REGISTRY_HTTP_SECRET=${REGISTRY_HTTP_SECRET}
      - REGISTRY_CONTROLLER_PORT=8080
      - REGISTRY_URL=http://registry:5000
    volumes:
      - registry_conf:/etc/registry
    env_file:
      - stack.env
    depends_on:
      - registry
    networks:
      - harbor

  chartmuseum:
    image: bitnami/harbor-chartmuseum:${HARBOR_VERSION:-2.10.2}
    container_name: harbor-chartmuseum
    restart: unless-stopped
    environment:
      - REGISTRY_STORAGE_PROVIDER_NAME=filesystem
    volumes:
      - chartmuseum_data:/bitnami
    env_file:
      - stack.env
    depends_on:
      - registry
    networks:
      - harbor

  portal:
    image: bitnami/harbor-portal:${HARBOR_VERSION:-2.10.2}
    container_name: harbor-portal
    restart: unless-stopped
    env_file:
      - stack.env
    networks:
      - harbor

  core:
    image: bitnami/harbor-core:${HARBOR_VERSION:-2.10.2}
    container_name: harbor-core
    restart: unless-stopped
    environment:
      - REGISTRY_URL=http://registry:5000
      - REGISTRY_CONTROLLER_URL=http://registryctl:8080
      - DATABASE_TYPE=postgresql
      - POSTGRESQL_HOST=postgresql
      - POSTGRESQL_PORT_NUMBER=5432
      - POSTGRESQL_USERNAME=${POSTGRESQL_USERNAME}
      - POSTGRESQL_PASSWORD=${POSTGRESQL_PASSWORD}
      - POSTGRESQL_DATABASE=${POSTGRESQL_DATABASE}
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/1
      - HARBOR_ADMIN_PASSWORD=${HARBOR_ADMIN_PASSWORD}
      - HARBOR_URL=https://${HARBOR_HOSTNAME}
      - CORE_SECRET=${CORE_SECRET}
      - JOBSERVICE_SECRET=${JOBSERVICE_SECRET}
      - TOKEN_SERVICE_URL=http://core:8080
      - HTTP_PROXY=${HTTP_PROXY:-}
      - HTTPS_PROXY=${HTTPS_PROXY:-}
      - NO_PROXY=${NO_PROXY:-core,portal,registry,registryctl,jobservice,trivy,chartmuseum,postgresql,redis,proxy,127.0.0.1,localhost}
      - INTERNAL_TLS_ENABLED=false
      - PORTAL_URL=http://portal:8080
    volumes:
      - core_data:/data
      - ca_bundle:/etc/harbor/ca
    env_file:
      - stack.env
    depends_on:
      - postgresql
      - redis
      - registry
      - registryctl
      - portal
      - chartmuseum
    networks:
      - harbor

  jobservice:
    image: bitnami/harbor-jobservice:${HARBOR_VERSION:-2.10.2}
    container_name: harbor-jobservice
    restart: unless-stopped
    environment:
      - CORE_SECRET=${CORE_SECRET}
      - JOBSERVICE_SECRET=${JOBSERVICE_SECRET}
      - REGISTRY_CONTROLLER_URL=http://registryctl:8080
      - METRIC_ENABLE=false
      - METRIC_PORT=8001
    volumes:
      - jobservice_data:/var/log/jobs
    env_file:
      - stack.env
    depends_on:
      - core
    networks:
      - harbor

  trivy:
    image: bitnami/harbor-trivy:${HARBOR_VERSION:-2.10.2}
    container_name: harbor-trivy
    restart: unless-stopped
    environment:
      - TRIVY_SECRET=${TRIVY_SECRET}
      - TRIVY_SERVER_TOKEN=${TRIVY_SECRET}
      - TRIVY_SKIP_UPDATE=true
      - CACHE_DIR=/home/scanner/.cache/trivy
    volumes:
      - trivy_cache:/home/scanner/.cache/trivy
    env_file:
      - stack.env
    depends_on:
      - core
    networks:
      - harbor

  proxy:
    image: bitnami/harbor-nginx:${HARBOR_VERSION:-2.10.2}
    container_name: harbor-proxy
    restart: unless-stopped
    ports:
      - "${HARBOR_HTTP_PORT:-8080}:8080"
      - "${HARBOR_HTTPS_PORT:-8443}:8443"
    volumes:
      - proxy_certs:/opt/bitnami/nginx/conf/certs
      - proxy_conf:/opt/bitnami/nginx/conf
    env_file:
      - stack.env
    depends_on:
      - core
      - jobservice
      - portal
      - registry
      - trivy
      - chartmuseum
    networks:
      - harbor

volumes:
  redis_data:
  postgresql_data:
  registry_data:
  registry_conf:
  chartmuseum_data:
  core_data:
  ca_bundle:
  jobservice_data:
  trivy_cache:
  proxy_certs:
  proxy_conf:

networks:
  harbor:
    driver: bridge
